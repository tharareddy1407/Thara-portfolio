<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Map Portfolio (Fast + Stable)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>

  <style>
    :root{
      --bg:#ffffff; --text:#111; --muted:#555; --card:#fff;
      --shadow:0 12px 30px rgba(0,0,0,.18);
      --pill:#fff; --pillText:#111; --border:rgba(0,0,0,.10);
    }
    body.dark{
      --bg:#0b1220; --text:#e7eefc; --muted:rgba(231,238,252,.75); --card:#121a2b;
      --shadow:0 12px 30px rgba(0,0,0,.55);
      --pill:#121a2b; --pillText:#e7eefc; --border:rgba(255,255,255,.14);
    }

    html, body { height:100%; margin:0; background:var(--bg); }
    #map { position:fixed; inset:0; }

    .topbar{
      position: fixed;
      top: env(safe-area-inset-top, 10px);
      left: 12px; right: 12px;
      z-index: 10;
      display:flex; justify-content:space-between; gap:10px;
      font-family: Arial, sans-serif;
      pointer-events:none;
    }
    .left,.right{ display:flex; gap:10px; flex-wrap:wrap; pointer-events:auto; }
    .pill{
      background:var(--pill);
      color:var(--pillText);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      padding:10px 12px;
      font-size:14px;
      cursor:pointer;
      user-select:none;
      text-decoration:none;
      white-space:nowrap;
    }
    .pill:active{ transform: translateY(1px); }

    #panel{
      position: fixed;
      top: calc(env(safe-area-inset-top, 10px) + 64px);
      left: 12px;
      z-index: 10;
      width: 380px;
      max-width: calc(100% - 24px);
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
      font-family: Arial, sans-serif;
      display:none;
    }
    #panel h3{ margin:0 0 8px; font-size:18px; }
    #panel .meta{ color: var(--muted); font-size:13px; margin-bottom:10px; }
    #panel .close{
      float:right; cursor:pointer; font-weight:700; font-size:18px;
      padding:4px 8px; border-radius:10px;
    }

    @media (max-width: 768px){
      #panel{
        left:0; right:0;
        top:auto; bottom:0;
        width:auto; max-width:none;
        border-radius:18px 18px 0 0;
        padding: 14px 16px calc(16px + env(safe-area-inset-bottom, 0px));
        box-shadow: 0 -10px 30px rgba(0,0,0,.18);
      }
    }

    .travelMarker{ width:1px; height:1px; pointer-events:none; }
    .travelEmoji{
      font-size: 28px;
      transform: translate(-50%, -50%);
      will-change: transform;
      filter: drop-shadow(0 6px 10px rgba(0,0,0,.25));
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="left">
      <div class="pill" id="tourBtn">‚ñ∂ Tour</div>
      <div class="pill" id="themeBtn">üåô Dark</div>
    </div>
    <div class="right">
      <a class="pill" href="https://github.com/tharareddy1407" target="_blank" rel="noopener">GitHub</a>
    </div>
  </div>

  <div id="panel">
    <span class="close" id="closePanel">√ó</span>
    <h3 id="panelTitle"></h3>
    <div class="meta" id="panelMeta"></div>
    <div id="panelBody"></div>
  </div>

  <div id="map"></div>

  <script>
    // Free CARTO vector styles (no API key)
    const STYLE_LIGHT = "https://basemaps.cartocdn.com/gl/positron-gl-style/style.json";
    const STYLE_DARK  = "https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json";

    // USA bounds (rough)
    const USA_BOUNDS = [
      [-125.0, 24.5],  // SW [lng,lat]
      [-66.5,  49.8]   // NE [lng,lat]
    ];

    // Normalize input in case you ever swap lat/lng
    function normalizeLngLat(ll){
      let a = Number(ll[0]), b = Number(ll[1]);
      // if looks like [lat,lng] => swap
      if (Math.abs(a) <= 90 && Math.abs(b) > 90) [a,b] = [b,a];
      a = Math.max(-180, Math.min(180, a));
      b = Math.max(-90,  Math.min(90,  b));
      return [a,b];
    }

    function densify(from, to, steps = 280){
      const pts = [];
      for (let i=0; i<=steps; i++){
        const t = i/steps;
        pts.push([ from[0] + (to[0]-from[0])*t, from[1] + (to[1]-from[1])*t ]);
      }
      return pts;
    }

    function chooseEmoji(from, to){
      const lonDiff = Math.abs(from[0]-to[0]);
      return lonDiff > 18 ? "‚úàÔ∏è" : "üöó";
    }

    // Data
    const places = {
      resume:     { name:"Resume",      city:"Denver, CO",      ll: normalizeLngLat([-104.9903, 39.7392]), color:"#3498db",
        html:`<ul><li>Highlights</li><li>Download link</li></ul>` },
      projects:   { name:"Projects",    city:"Los Angeles, CA", ll: normalizeLngLat([-118.2437, 34.0522]), color:"#e74c3c",
        html:`<ul><li>Map Portfolio</li><li>Other projects</li></ul>` },
      skills:     { name:"Tech Skills", city:"Dallas, TX",      ll: normalizeLngLat([-96.7970, 32.7767]),  color:"#2ecc71",
        html:`<ul><li>Python</li><li>SQL</li><li>AWS</li></ul>` },
      experience: { name:"Experience",  city:"New York, NY",    ll: normalizeLngLat([-74.0060, 40.7128]),  color:"#9b59b6",
        html:`<ul><li>Role 1</li><li>Role 2</li></ul>` },
      contact:    { name:"Contact Me",  city:"Atlanta, GA",     ll: normalizeLngLat([-84.3880, 33.7490]),  color:"#f1c40f",
        html:`<ul>
          <li>Email: <a href="mailto:yourname@email.com">yourname@email.com</a></li>
          <li>GitHub: <a target="_blank" rel="noopener" href="https://github.com/tharareddy1407">Profile</a></li>
        </ul>` }
    };

    // Panel
    const panel = document.getElementById("panel");
    const panelTitle = document.getElementById("panelTitle");
    const panelMeta  = document.getElementById("panelMeta");
    const panelBody  = document.getElementById("panelBody");
    document.getElementById("closePanel").onclick = () => panel.style.display = "none";

    function openPanel(key){
      const p = places[key];
      panelTitle.textContent = p.name;
      panelMeta.textContent  = p.city;
      panelBody.innerHTML    = p.html;
      panel.style.display = "block";
    }

    // Map
    let isDark = false;
    const map = new maplibregl.Map({
      container: "map",
      style: STYLE_LIGHT,
      center: [-98.5, 39.8],
      zoom: 4.2,
      minZoom: 4,
      maxZoom: 10,
      maxBounds: USA_BOUNDS
    });

    map.addControl(new maplibregl.NavigationControl({ showCompass: false }), "top-left");

    window.addEventListener("resize", () => map.resize());
    window.addEventListener("orientationchange", () => setTimeout(() => map.resize(), 150));

    // Sources/Layers
    const DEST_SOURCE = "destinations";
    const ROUTE_SOURCE = "route";

    function destGeoJSON(){
      return {
        type:"FeatureCollection",
        features: Object.entries(places).map(([key,p]) => ({
          type:"Feature",
          geometry:{ type:"Point", coordinates:p.ll },
          properties:{ key, name:p.name, city:p.city, color:p.color }
        }))
      };
    }

    function ensureLayers(){
      // Sources
      if (!map.getSource(DEST_SOURCE)) {
        map.addSource(DEST_SOURCE, { type:"geojson", data: destGeoJSON() });
      } else {
        map.getSource(DEST_SOURCE).setData(destGeoJSON());
      }

      if (!map.getSource(ROUTE_SOURCE)) {
        map.addSource(ROUTE_SOURCE, {
          type:"geojson",
          data:{ type:"FeatureCollection", features:[{
            type:"Feature",
            geometry:{ type:"LineString", coordinates:[places.resume.ll, places.resume.ll] },
            properties:{}
          }]}
        });
      }

      // Route
      if (!map.getLayer("route-line")) {
        map.addLayer({
          id:"route-line",
          type:"line",
          source: ROUTE_SOURCE,
          layout:{ "line-cap":"round", "line-join":"round" },
          paint:{
            "line-color":"#2f80ff",
            "line-opacity":0.9,
            "line-width":[
              "interpolate", ["linear"], ["zoom"],
              4, 2,
              6, 4,
              8, 6,
              10, 8
            ],
            "line-dasharray":[2,2]
          }
        });
      }

      // Pins
      if (!map.getLayer("dest-circles")) {
        map.addLayer({
          id:"dest-circles",
          type:"circle",
          source: DEST_SOURCE,
          paint:{
            "circle-color":["get","color"],
            "circle-stroke-color":"#ffffff",
            "circle-stroke-width":2,
            "circle-radius":[
              "interpolate", ["linear"], ["zoom"],
              4, 6,
              6, 8,
              8, 10,
              10, 12
            ]
          }
        });
      }
    }

    function setRoute(from, to){
      const src = map.getSource(ROUTE_SOURCE);
      if (!src) return;
      src.setData({
        type:"FeatureCollection",
        features:[{ type:"Feature", geometry:{ type:"LineString", coordinates:[from, to] }, properties:{} }]
      });
    }

    // Dash animation (interval) ‚Äî ALWAYS single instance
    let dashTimer = null;
    let dashTick = 0;
    const dashPatterns = [[2,2],[3,2],[4,2],[3,3]];
    function startDash(){
      stopDash();
      dashTimer = setInterval(() => {
        dashTick = (dashTick + 1) % dashPatterns.length;
        if (map.getLayer("route-line")) {
          map.setPaintProperty("route-line", "line-dasharray", dashPatterns[dashTick]);
        }
      }, 180);
    }
    function stopDash(){
      if (dashTimer) clearInterval(dashTimer);
      dashTimer = null;
    }

    // Travel marker (DOM)
    const travelEl = document.createElement("div");
    travelEl.className = "travelMarker";
    const travelEmoji = document.createElement("div");
    travelEmoji.className = "travelEmoji";
    travelEmoji.textContent = "üöó";
    travelEl.appendChild(travelEmoji);

    const travelMarker = new maplibregl.Marker({ element: travelEl })
      .setLngLat(places.resume.ll)
      .addTo(map);

    function rotateEmoji(prev, cur){
      const dx = cur[0] - prev[0];
      const dy = cur[1] - prev[1];
      const angle = Math.atan2(dy, dx) * 180 / Math.PI;
      travelEmoji.style.transform = `translate(-50%, -50%) rotate(${angle}deg)`;
    }

    // ----------------- üî• STABILITY: TRAVEL CONTROLLER -----------------
    const Travel = {
      raf: null,
      token: 0,
      running: false,
      resolve: null,

      cancel(){
        this.token++;
        this.running = false;
        if (this.raf) cancelAnimationFrame(this.raf);
        this.raf = null;
        stopDash();
        if (this.resolve) { this.resolve(); this.resolve = null; }
      },

      run(from, to, durationMs){
        this.cancel();
        this.running = true;
        const myToken = ++this.token;

        startDash();
        setRoute(from, to);

        // Smooth camera (no fitBounds, avoids freezes)
        map.easeTo({ center: to, duration: 650, zoom: Math.max(map.getZoom(), 5.2) });

        const path = densify(from, to, 300);
        const start = performance.now();
        const last = path.length - 1;
        const ease = t => 1 - Math.pow(1 - t, 3);

        return new Promise((res) => {
          this.resolve = res;

          // Failsafe so it NEVER gets stuck
          const failsafe = setTimeout(() => {
            if (this.token === myToken) {
              this.running = false;
              stopDash();
              this.resolve?.();
              this.resolve = null;
            }
          }, durationMs + 1200);

          const step = (now) => {
            if (this.token !== myToken) { clearTimeout(failsafe); return; }
            const t = Math.min((now - start) / durationMs, 1);
            const idx = Math.min(Math.floor(ease(t) * last), last);

            const cur = path[idx];
            travelMarker.setLngLat(cur);
            rotateEmoji(path[Math.max(idx-1,0)], cur);

            if (t < 1) {
              this.raf = requestAnimationFrame(step);
            } else {
              clearTimeout(failsafe);
              this.raf = null;
              this.running = false;
              stopDash();
              this.resolve?.();
              this.resolve = null;
            }
          };

          this.raf = requestAnimationFrame(step);
        });
      }
    };

    // Travel API (awaitable)
    let currentKey = "resume";

    async function travelTo(key){
      if (!places[key]) return;

      // same key ‚Üí just open
      if (key === currentKey && !Travel.running) {
        openPanel(key);
        return;
      }

      const from = places[currentKey].ll;
      const to   = places[key].ll;

      travelEmoji.textContent = chooseEmoji(from, to);

      // Update currentKey early (prevents tour deadlocks)
      currentKey = key;

      await Travel.run(from, to, 1400);
      openPanel(key);
    }

    // ----------------- üî• STABILITY: TOUR WAITS FOR TRAVEL -----------------
    const tourOrder = ["resume","projects","skills","experience","contact"];
    let tourOn = false;
    let tourStopToken = 0;

    async function startTour(){
      tourOn = true;
      document.getElementById("tourBtn").textContent = "‚è∏ Tour";
      const my = ++tourStopToken;

      // loop forever (until stopped), but always await travel
      let i = 0;
      while (tourOn && tourStopToken === my) {
        const key = tourOrder[i % tourOrder.length];
        i++;
        await travelTo(key);

        // small pause between stops (also cancellable)
        await new Promise(r => setTimeout(r, 700));
      }
    }

    function stopTour(){
      tourOn = false;
      tourStopToken++;
      document.getElementById("tourBtn").textContent = "‚ñ∂ Tour";
      Travel.cancel(); // stop any mid-flight to prevent stuck state
    }

    document.getElementById("tourBtn").onclick = () => {
      if (tourOn) stopTour();
      else startTour();
    };

    // ----------------- Click pins (no duplicates) -----------------
    function bindClickHandlersOnce(){
      // Remove old handlers first (important after style reload)
      map.off("click", "dest-circles", onPinClick);
      map.off("mouseenter", "dest-circles", onEnter);
      map.off("mouseleave", "dest-circles", onLeave);

      map.on("click", "dest-circles", onPinClick);
      map.on("mouseenter", "dest-circles", onEnter);
      map.on("mouseleave", "dest-circles", onLeave);
    }

    function onPinClick(e){
      stopTour();
      const f = e.features && e.features[0];
      if (!f) return;
      const key = f.properties.key;
      travelTo(key);
    }
    function onEnter(){ map.getCanvas().style.cursor = "pointer"; }
    function onLeave(){ map.getCanvas().style.cursor = ""; }

    // Theme toggle (re-add layers + rebind handlers safely)
    document.getElementById("themeBtn").onclick = () => {
      isDark = !isDark;
      document.body.classList.toggle("dark", isDark);
      document.getElementById("themeBtn").textContent = isDark ? "‚òÄÔ∏è Light" : "üåô Dark";

      // Cancel travel/tour during style change (avoids deadlock)
      stopTour();
      Travel.cancel();

      const center = map.getCenter();
      const zoom = map.getZoom();
      map.setStyle(isDark ? STYLE_DARK : STYLE_LIGHT);

      map.once("load", () => {
        ensureLayers();
        bindClickHandlersOnce();
        map.jumpTo({ center, zoom });
        // restore route (optional)
        setRoute(places[currentKey].ll, places[currentKey].ll);
      });
    };

    // Init
    map.on("load", () => {
      ensureLayers();
      bindClickHandlersOnce();
      map.easeTo({ center: places.resume.ll, zoom: 5.8, duration: 0 });
      openPanel("resume");
    });
  </script>
</body>
</html>
